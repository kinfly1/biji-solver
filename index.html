<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¯”é¸¡ç¥å™¨ (ç§»åŠ¨ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2980b9;
            --accent: #27ae60;
            --danger: #c0392b;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --card-w: 42px;
            --card-h: 58px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f6fa;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* ç¦æ­¢æ•´ä½“æ»šåŠ¨ï¼Œåªå…è®¸å†…å®¹åŒºæ»šåŠ¨ */
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        header {
            background: white;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 18px; color: var(--dark); font-weight: 800; }
        
        .player-toggle {
            display: flex;
            background: #f1f2f6;
            border-radius: 8px;
            padding: 2px;
        }
        .p-btn {
            border: none; background: none; padding: 4px 10px; font-size: 13px;
            border-radius: 6px; color: #7f8c8d; font-weight: 600;
        }
        .p-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* ä¸»å†…å®¹æ»šåŠ¨åŒº */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨æŒ‰é’®ç•™ç©º */
            -webkit-overflow-scrolling: touch;
        }

        /* é€‰ç‰ŒåŒºåŸŸ - æ¨ªå‘æ»šåŠ¨ä¼˜åŒ– */
        .suit-section { margin-bottom: 12px; background: white; padding: 8px 0; border-radius: 8px; }
        .suit-label { 
            font-size: 12px; color: #95a5a6; margin-left: 10px; margin-bottom: 4px; font-weight: bold; text-transform: uppercase;
        }
        .card-scroller {
            display: flex;
            overflow-x: auto;
            padding: 0 10px;
            gap: 6px;
            scrollbar-width: none; /* Firefox éšè—æ»šåŠ¨æ¡ */
        }
        .card-scroller::-webkit-scrollbar { display: none; /* Chrome/Safari éšè—æ»šåŠ¨æ¡ */ }

        .card-btn {
            flex: 0 0 auto; /* ç¦æ­¢å‹ç¼© */
            width: var(--card-w);
            height: var(--card-h);
            border: 1px solid #dfe6e9;
            border-radius: 6px;
            background: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
            position: relative;
            transition: all 0.1s;
        }
        
        .card-btn.red { color: #e74c3c; }
        .card-btn.black { color: #2c3e50; }
        
        /* é€‰ä¸­çŠ¶æ€ */
        .card-btn.selected {
            background: var(--primary);
            color: white !important;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(41, 128, 185, 0.3);
        }
        .card-btn.selected::after {
            content: 'âœ“'; position: absolute; top: -4px; right: -4px;
            background: var(--accent); color: white; font-size: 10px;
            width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        /* ç»“æœå¡ç‰‡ */
        .result-card {
            background: white; border-radius: 12px; margin-top: 15px; overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .res-header {
            background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .res-badge { background: var(--accent); color: white; font-size: 12px; padding: 2px 8px; border-radius: 4px; }
        .res-row {
            display: flex; padding: 10px 15px; border-bottom: 1px dashed #f1f2f6; align-items: center;
        }
        .res-label { font-size: 13px; color: #999; width: 35px; }
        .res-cards { flex: 1; display: flex; gap: 4px; }
        .mini-c {
            padding: 2px 5px; border: 1px solid #eee; border-radius: 4px; font-size: 14px; min-width: 24px; text-align: center;
        }
        .res-type { font-size: 13px; font-weight: bold; color: var(--primary); margin-left: auto; }

        /* åº•éƒ¨å›ºå®šæ“ä½œæ  */
        .bottom-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: white;
            padding: 10px 15px;
            padding-bottom: calc(10px + var(--safe-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .action-btn {
            border: none; border-radius: 10px; font-size: 16px; font-weight: bold;
            height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-reset { width: 48px; background: #f1f2f6; color: var(--danger); font-size: 20px; }
        .btn-calc { flex: 1; background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3); }
        .btn-calc:active { transform: scale(0.98); }
        
        #status-bar {
            position: absolute; top: -30px; left: 0; right: 0; text-align: center;
            font-size: 12px; color: #666; background: rgba(255,255,255,0.9); padding: 5px;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .spinner { width: 18px; height: 18px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <header>
        <h1>ğŸ” æ¯”é¸¡ç¥å™¨</h1>
        <div class="player-toggle">
            <button class="p-btn" onclick="setPlayers(2)">2äºº</button>
            <button class="p-btn active" onclick="setPlayers(3)">3äºº</button>
            <button class="p-btn" onclick="setPlayers(4)">4äºº</button>
            <button class="p-btn" onclick="setPlayers(5)">5äºº</button>
        </div>
    </header>

    <main id="main-content">
        <div id="selector-container"></div>
        
        <div id="results-container">
            <div style="text-align:center; color:#bdc3c7; margin-top:50px; font-size:14px;">
                <p>ğŸ‘† è¯·ä¸Šæ–¹æ»‘åŠ¨é€‰æ‹©9å¼ æ‰‹ç‰Œ</p>
                <p>ğŸ‘‡ ç‚¹å‡»åº•éƒ¨æŒ‰é’®å¼€å§‹è®¡ç®—</p>
            </div>
        </div>
    </main>

    <div class="bottom-bar">
        <div id="status-bar">å·²é€‰ 0/9</div>
        <button class="action-btn btn-reset" onclick="reset()">â†º</button>
        <button class="action-btn btn-calc" onclick="runAI()" id="calc-btn">å¼€å§‹è®¡ç®— (AI)</button>
    </div>

<script>
    // --- é€»è¾‘ä¸ä¹‹å‰å®Œå…¨ä¸€è‡´ï¼Œä»…ä¼˜åŒ–äº¤äº’ ---
    
    const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
    const SUIT_NAMES = ['é»‘æ¡ƒ Spade', 'çº¢å¿ƒ Heart', 'æ¢…èŠ± Club', 'æ–¹å— Diamond'];
    const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    const TYPE = { HIGH: 1, PAIR: 2, STRAIGHT: 3, FLUSH: 4, STRAIGHT_FLUSH: 5, BOMB: 6 };
    
    let state = { selected: new Set(), players: 3, simulations: 2000 };

    function init() {
        const container = document.getElementById('selector-container');
        SUITS.forEach((s, sIdx) => {
            const section = document.createElement('div');
            section.className = 'suit-section';
            
            const label = document.createElement('div');
            label.className = 'suit-label';
            label.innerText = SUIT_NAMES[sIdx];
            section.appendChild(label);

            const scroller = document.createElement('div');
            scroller.className = 'card-scroller';

            RANKS.forEach((r, rIdx) => {
                const idx = sIdx * 13 + rIdx;
                const btn = document.createElement('div');
                btn.className = `card-btn ${sIdx % 2 === 1 ? 'red' : 'black'}`;
                btn.innerHTML = `<small style="font-size:10px">${s}</small>${r}`;
                btn.id = `c-${idx}`;
                btn.onclick = () => toggleCard(idx);
                scroller.appendChild(btn);
            });
            section.appendChild(scroller);
            container.appendChild(section);
        });
    }

    function toggleCard(idx) {
        // éœ‡åŠ¨åé¦ˆ (Android Only)
        if (navigator.vibrate) navigator.vibrate(10);
        
        const btn = document.getElementById(`c-${idx}`);
        if (state.selected.has(idx)) {
            state.selected.delete(idx);
            btn.classList.remove('selected');
        } else {
            if (state.selected.size >= 9) return alert('æœ€å¤šåªèƒ½é€‰9å¼ ç‰Œ');
            state.selected.add(idx);
            btn.classList.add('selected');
        }
        updateStatus();
    }

    function updateStatus() {
        const count = state.selected.size;
        const bar = document.getElementById('status-bar');
        const btn = document.getElementById('calc-btn');
        
        bar.innerText = `å·²é€‰ ${count}/9`;
        
        if (count === 9) {
            btn.style.background = '#27ae60'; // Green
            btn.innerHTML = 'âœ¨ ç«‹å³è®¡ç®— âœ¨';
        } else {
            btn.style.background = '#2980b9'; // Blue
            btn.innerHTML = `è¿˜éœ€è¦é€‰ ${9-count} å¼ `;
        }
    }

    function setPlayers(n) {
        state.players = n;
        document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    function reset() {
        state.selected.clear();
        document.querySelectorAll('.card-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById('results-container').innerHTML = '';
        updateStatus();
    }

    // --- ç®—æ³•æ ¸å¿ƒ (ä¿æŒä¸å˜) ---
    function getHandRank(cards) {
        const v = cards.map(c => c.val);
        const s = cards.map(c => c.suit);
        const isFlush = s[0] === s[1] && s[1] === s[2];
        let isStraight = (v[2] === v[1]+1 && v[1] === v[0]+1);
        if (!isStraight && v[0]===0 && v[1]===1 && v[2]===12) isStraight = true; 

        if (v[0] === v[1] && v[1] === v[2]) return { t: TYPE.BOMB, v: v[0], label: "è±¹å­" };
        if (isFlush && isStraight) return { t: TYPE.STRAIGHT_FLUSH, v: v[2], label: "åŒèŠ±é¡º" };
        if (isFlush) return { t: TYPE.FLUSH, v: v[2] + v[1]/100, label: "åŒèŠ±" };
        if (isStraight) {
             let top = (v[2]===12 && v[0]===0) ? v[1] : v[2];
             return { t: TYPE.STRAIGHT, v: top, label: "é¡ºå­" };
        }
        if (v[0]===v[1] || v[1]===v[2]) {
            let p = (v[0]===v[1]) ? v[0] : v[1];
            let k = (v[0]===v[1]) ? v[2] : v[0];
            return { t: TYPE.PAIR, v: p*100 + k, label: "å¯¹å­" };
        }
        return { t: TYPE.HIGH, v: v[2]*10000 + v[1]*100 + v[0], label: "æ•£ç‰Œ" };
    }

    function compareHands(h1, h2) {
        if (h1.t !== h2.t) return h1.t - h2.t;
        return h1.v - h2.v;
    }

    function getCombinations(arr, k) {
        let res = [];
        let f = (start, combo) => {
            if (combo.length === k) { res.push([...combo]); return; }
            for(let i=start; i<arr.length; i++) {
                combo.push(arr[i]); f(i+1, combo); combo.pop();
            }
        };
        f(0, []);
        return res;
    }

    async function runAI() {
        if (state.selected.size !== 9) return alert("è¯·å…ˆé€‰æ»¡9å¼ ç‰Œ");
        
        const btn = document.getElementById('calc-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<div class="spinner"></div> è®¡ç®—ä¸­...';
        btn.disabled = true;

        await new Promise(r => setTimeout(r, 50)); // UI Render gap

        const myCardsRaw = Array.from(state.selected);
        const myCards = myCardsRaw.map(i => ({ val: i%13, suit: Math.floor(i/13), id: i }));
        let deck = [];
        for(let i=0; i<52; i++) if (!state.selected.has(i)) deck.push(i);

        // 1. ç”Ÿæˆæ‰€æœ‰åˆæ³•ç»„åˆ
        let validSplits = [];
        const heads = getCombinations(myCards, 3);
        
        for (let head of heads) {
            let rem1 = myCards.filter(c => !head.includes(c));
            let hRank = getHandRank(sortH(head));
            let mids = getCombinations(rem1, 3);
            for (let mid of mids) {
                let tail = rem1.filter(c => !mid.includes(c));
                let mRank = getHandRank(sortH(mid));
                if (compareHands(mRank, hRank) < 0) continue; // å€’æ°´
                
                let tRank = getHandRank(sortH(tail));
                if (compareHands(tRank, mRank) < 0) continue; // å€’æ°´

                validSplits.push({ head, mid, tail, hRank, mRank, tRank, score: 0 });
            }
        }

        if (validSplits.length === 0) {
            document.getElementById('results-container').innerHTML = '<div style="padding:20px; text-align:center; color:#e74c3c">æ— è§£ï¼šæ— æ³•æ‘†å‡ºä¸å€’æ°´çš„ç‰Œå‹</div>';
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }

        // 2. è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ
        const OPPONENTS = state.players - 1;
        // é’ˆå¯¹æ‰‹æœºç«¯ç¨å¾®é™ä½æ¨¡æ‹Ÿæ¬¡æ•°ä»¥ä¿è¯æµç•…åº¦ï¼Œæˆ–è€…ä¿æŒ200
        const ROUNDS = 200; 

        for (let split of validSplits) {
            for (let i = 0; i < ROUNDS; i++) {
                shuffle(deck);
                let idx = 0;
                let roundScore = 0;
                for (let op = 0; op < OPPONENTS; op++) {
                    // æ¨¡æ‹Ÿå¯¹æ‰‹å‘ç‰Œ
                    let opH = [deck[idx++], deck[idx++], deck[idx++]];
                    let opM = [deck[idx++], deck[idx++], deck[idx++]];
                    let opT = [deck[idx++], deck[idx++], deck[idx++]];
                    
                    if (compareHands(split.hRank, getHandRank(sortRaw(opH))) > 0) roundScore++;
                    if (compareHands(split.mRank, getHandRank(sortRaw(opM))) > 0) roundScore++;
                    if (compareHands(split.tRank, getHandRank(sortRaw(opT))) > 0) roundScore++;
                }
                split.score += roundScore;
            }
        }

        validSplits.sort((a, b) => b.score - a.score);
        renderResults(validSplits.slice(0, 3)); // åªæ˜¾ç¤ºå‰3

        btn.innerHTML = originalText;
        btn.disabled = false;
        
        // æ»šåŠ¨åˆ°ç»“æœåŒº
        document.getElementById('main-content').scrollTop = document.getElementById('results-container').offsetTop - 20;
    }

    function sortH(cards) { return [...cards].sort((a,b)=>a.val - b.val); }
    function sortRaw(idxs) { return idxs.map(i => ({val: i%13, suit: Math.floor(i/13)})).sort((a,b)=>a.val-b.val); }
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function renderResults(solutions) {
        const area = document.getElementById('results-container');
        area.innerHTML = '';

        solutions.forEach((sol, idx) => {
            const div = document.createElement('div');
            div.className = 'result-card';
            
            let badge = idx === 0 ? "ğŸ”¥ æ¨èæ–¹æ¡ˆ" : `å¤‡é€‰ ${idx+1}`;
            
            div.innerHTML = `
                <div class="res-header">
                    <span style="font-weight:bold; color:#2c3e50">${badge}</span>
                    <span class="res-badge">å¼ºåº¦: ${Math.floor(sol.score)}</span>
                </div>
                ${renderRow('å°¾å¢©', sol.tail, sol.tRank)}
                ${renderRow('ä¸­å¢©', sol.mid, sol.mRank)}
                ${renderRow('å¤´å¢©', sol.head, sol.hRank)}
            `;
            area.appendChild(div);
        });
    }

    function renderRow(label, cards, rank) {
        let html = cards.map(c => {
            let color = (c.suit === 1 || c.suit === 3) ? 'red' : 'black';
            return `<span class="mini-c" style="color:${color}">${SUITS[c.suit]}${RANKS[c.val]}</span>`;
        }).join('');
        
        return `
            <div class="res-row">
                <span class="res-label">${label}</span>
                <div class="res-cards">${html}</div>
                <span class="res-type">${rank.label}</span>
            </div>
        `;
    }

    init();
</script>
</body>
</html>
